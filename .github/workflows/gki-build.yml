name: GKI Kernel Build

permissions:
  contents: write
  actions: write

on:
  workflow_call:
    inputs:
      android_version:
        type: string
        required: true
      kernel_version:
        type: string
        required: true
      sub_level:
        type: string
        required: true
      os_patch_level:
        type: string
        required: true
      add_susfs:
        type: boolean
        default: true
      add_zeromount:
        type: boolean
        default: true
      add_zram:
        type: boolean
        default: true
      add_bbg:
        type: boolean
        default: true
      ksu_variant:
        type: string
        default: "KernelSU-Next"
      add_enhanced_susfs:
        type: boolean
        default: true
      add_unicode_filter:
        type: boolean
        default: true
      device_codename:
        type: string
        default: ""

jobs:
  build:
    name: "${{ inputs.ksu_variant }} ${{ inputs.kernel_version }}.${{ inputs.sub_level }}"
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set Build Parameters
      run: |
        echo "ANDROID_VERSION=${{ inputs.android_version }}" >> $GITHUB_ENV
        echo "KERNEL_VERSION=${{ inputs.kernel_version }}" >> $GITHUB_ENV
        echo "SUB_LEVEL=${{ inputs.sub_level }}" >> $GITHUB_ENV
        echo "OS_PATCH_LEVEL=${{ inputs.os_patch_level }}" >> $GITHUB_ENV
        echo "VERSION_DIR=${{ inputs.android_version }}-${{ inputs.kernel_version }}" >> $GITHUB_ENV

    - name: Free Disk Space
      uses: endersonmenezes/free-disk-space@v3
      with:
        remove_android: true
        remove_dotnet: true
        remove_haskell: true
        remove_tool_cache: true
        remove_swap: true
        remove_packages: "azure-cli google-cloud-cli microsoft-edge-stable google-chrome-stable firefox postgresql* temurin-* *llvm* mysql* dotnet-sdk-*"
        remove_packages_one_command: true
        remove_folders: "/usr/share/swift /usr/share/miniconda /usr/share/az* /usr/local/lib/node_modules /usr/local/share/chromium /usr/local/share/powershell /usr/local/julia /usr/local/aws-cli /usr/local/aws-sam-cli /usr/share/gradle"
        rm_cmd: "rmz"
        rmz_version: "3.1.1"
        testing: false

    - name: Setup Build Environment
      run: |
        CONFIG="${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}-${{ env.SUB_LEVEL }}"
        KERNEL_ROOT="$GITHUB_WORKSPACE/$CONFIG"
        mkdir -p "$KERNEL_ROOT"

        cat >> $GITHUB_ENV << EOF
        DEFCONFIG=$KERNEL_ROOT/common/arch/arm64/configs/gki_defconfig
        CONFIG=$CONFIG
        KERNEL_ROOT=$KERNEL_ROOT
        ANYKERNEL3=$GITHUB_WORKSPACE/AnyKernel3
        SUSFS4KSU=$GITHUB_WORKSPACE/susfs4ksu
        KERNEL_PATCHES=$GITHUB_WORKSPACE/kernel_patches
        REPO=$GITHUB_WORKSPACE/git-repo/repo
        EOF

        mkdir -p "$GITHUB_WORKSPACE/git-repo"
        curl -L https://storage.googleapis.com/git-repo-downloads/repo -o "$GITHUB_WORKSPACE/git-repo/repo"
        chmod 0755 "$GITHUB_WORKSPACE/git-repo/repo"
        echo "$GITHUB_WORKSPACE/git-repo" >> "$GITHUB_PATH"

    - name: Clone Dependencies
      run: |
        git clone https://github.com/WildKernels/AnyKernel3.git -b gki-2.0
        rm -rf AnyKernel3/.git
        git clone https://github.com/ShirkNeko/SukiSU_patch.git
        git clone https://github.com/WildKernels/kernel_patches.git

    - name: Initialize and Sync Kernel Source
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        FORMATTED_BRANCH="${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}-${{ env.OS_PATCH_LEVEL }}"

        repo init -u https://android.googlesource.com/kernel/manifest -b common-${FORMATTED_BRANCH} --repo-rev=stable --depth=1

        REMOTE_BRANCH=$(git ls-remote https://android.googlesource.com/kernel/common ${FORMATTED_BRANCH})
        DEFAULT_MANIFEST_PATH=.repo/manifests/default.xml
        if grep -q deprecated <<< $REMOTE_BRANCH; then
          sed -i "s/\"${FORMATTED_BRANCH}\"/\"deprecated\/${FORMATTED_BRANCH}\"/g" $DEFAULT_MANIFEST_PATH
        fi

        repo --trace sync -c -j$(nproc --all) --fail-fast --no-tags --force-sync --no-clone-bundle

    - name: Extract Sublevel
      run: |
        ACTUAL_SUBLEVEL="${{ env.SUB_LEVEL }}"
        if [[ -f "$KERNEL_ROOT/common/Makefile" ]]; then
          EXTRACTED=$(grep '^SUBLEVEL = ' "$KERNEL_ROOT/common/Makefile" | awk '{print $3}')
          [[ -n "$EXTRACTED" ]] && ACTUAL_SUBLEVEL="$EXTRACTED"
        fi

        ARTIFACT_BASE="${{ env.KERNEL_VERSION }}.$ACTUAL_SUBLEVEL-${{ env.ANDROID_VERSION }}-${{ env.OS_PATCH_LEVEL }}-${{ inputs.ksu_variant }}-SUSFS"
        echo "ACTUAL_SUBLEVEL=$ACTUAL_SUBLEVEL" >> $GITHUB_ENV
        echo "ARTIFACT_BASE=$ARTIFACT_BASE" >> $GITHUB_ENV
        echo "FILE_NAME=$ARTIFACT_BASE" >> $GITHUB_ENV

    - name: Apply glibc 2.38 Compatibility Fix
      run: |
        if [[ "${{ env.ANDROID_VERSION }}" == "android13" && "${{ env.KERNEL_VERSION }}" == "5.10" && $ACTUAL_SUBLEVEL -le 186 ]] ||
           [[ "${{ env.ANDROID_VERSION }}" == "android13" && "${{ env.KERNEL_VERSION }}" == "5.15" && $ACTUAL_SUBLEVEL -le 119 ]] ||
           [[ "${{ env.ANDROID_VERSION }}" == "android14" && "${{ env.KERNEL_VERSION }}" == "5.15" && $ACTUAL_SUBLEVEL -le 110 ]] ||
           [[ "${{ env.ANDROID_VERSION }}" == "android14" && "${{ env.KERNEL_VERSION }}" == "6.1" && $ACTUAL_SUBLEVEL -le 43 ]]; then
          GLIBC_VERSION=$(ldd --version 2>/dev/null | head -n 1 | awk '{print $NF}')
          if [ "$(printf '%s\n' "2.38" "$GLIBC_VERSION" | sort -V | head -n1)" = "2.38" ]; then
            cd "$KERNEL_ROOT/common"
            sed -i '/\$(Q)\$(MAKE) -C \$(SUBCMD_SRC) OUTPUT=\$(abspath \$(dir \$@))\/ \$(abspath \$@)/s//$(Q)$(MAKE) -C $(SUBCMD_SRC) EXTRA_CFLAGS="$(CFLAGS)" OUTPUT=$(abspath $(dir $@))\/ $(abspath $@)/' tools/bpf/resolve_btfids/Makefile 2>/dev/null || true
            if [[ "${{ env.ANDROID_VERSION }}" == "android13" && "${{ env.KERNEL_VERSION }}" == "5.10" && $ACTUAL_SUBLEVEL -le 186 ]] ||
               [[ "${{ env.ANDROID_VERSION }}" == "android13" && "${{ env.KERNEL_VERSION }}" == "5.15" && $ACTUAL_SUBLEVEL -le 119 ]] ||
               [[ "${{ env.ANDROID_VERSION }}" == "android14" && "${{ env.KERNEL_VERSION }}" == "5.15" && $ACTUAL_SUBLEVEL -le 110 ]]; then
              sed -i '/char \*buf = NULL;/a int i;' tools/lib/subcmd/parse-options.c 2>/dev/null || true
              sed -i 's/for (int i = 0; subcommands\[i\]; i++) {/for (i = 0; subcommands[i]; i++) {/' tools/lib/subcmd/parse-options.c 2>/dev/null || true
              sed -i '/if (subcommands) {/a int i;' tools/lib/subcmd/parse-options.c 2>/dev/null || true
              sed -i 's/for (int i = 0; subcommands\[i\]; i++)/for (i = 0; subcommands[i]; i++)/' tools/lib/subcmd/parse-options.c 2>/dev/null || true
            fi
          fi
        fi

    - name: Setup KernelSU
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        KSU_VARIANT="${{ inputs.ksu_variant }}"

        if [[ "$KSU_VARIANT" == "SukiSU" ]]; then
          echo "=== Adding SukiSU ==="
          BRANCH="main"
          [[ "${{ inputs.add_susfs }}" == "true" ]] && BRANCH="susfs-dev"
          curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/main/kernel/setup.sh" | bash -s "$BRANCH"
        elif [[ "$KSU_VARIANT" == "MKSU" ]]; then
          echo "=== Adding MKSU ==="
          BRANCH="main"
          [[ "${{ inputs.add_susfs }}" == "true" ]] && BRANCH="susfs-dev"
          curl -LSs "https://raw.githubusercontent.com/5ec1cff/KernelSU/main/kernel/setup.sh" | bash -s "$BRANCH"
        else
          echo "=== Adding KernelSU-Next ==="
          BRANCH="next"
          [[ "${{ inputs.add_susfs }}" == "true" ]] && BRANCH="dev_susfs"
          curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/${BRANCH}/kernel/setup.sh" | bash -s "$BRANCH"
        fi

        if [[ "$KSU_VARIANT" == "KernelSU-Next" ]]; then
          echo "KSU_DIR=KernelSU-Next" >> $GITHUB_ENV
        else
          echo "KSU_DIR=KernelSU" >> $GITHUB_ENV
        fi
        echo "=== $KSU_VARIANT added ==="

    - name: Fix KernelSU API Compatibility
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        KSUD_FILE="$KERNEL_ROOT/${{ env.KSU_DIR }}/kernel/ksud.c"
        if [ -f "$KSUD_FILE" ] && ! grep -q "ksu_handle_sys_newfstatat" "$KSUD_FILE"; then
          awk '/void ksu_handle_vfs_fstat/{found=1} found && /^}/{print; print "void ksu_handle_sys_newfstatat(int fd, loff_t *kstat_size_ptr) { }"; found=0; next}1' "$KSUD_FILE" > "$KSUD_FILE.tmp" && mv "$KSUD_FILE.tmp" "$KSUD_FILE"
          echo "[+] ksu_handle_sys_newfstatat stub added to ksud.c"
        fi

    - name: Clone Upstream SUSFS and Inject Custom Features
      if: inputs.add_susfs
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        SUSFS_BRANCH="gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}-dev"
        SUSFS_PIN_FILE="$GITHUB_WORKSPACE/${{ env.VERSION_DIR }}/susfs-pin.txt"

        if [ -f "$SUSFS_PIN_FILE" ] && [ -s "$SUSFS_PIN_FILE" ]; then
          SUSFS_PIN=$(tr -d '[:space:]' < "$SUSFS_PIN_FILE")
          echo "=== Cloning SUSFS (branch: $SUSFS_BRANCH, pinned: ${SUSFS_PIN:0:12}) ==="
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b "$SUSFS_BRANCH" "$SUSFS4KSU"
          git -C "$SUSFS4KSU" checkout "$SUSFS_PIN"
        else
          echo "=== Cloning SUSFS (branch: $SUSFS_BRANCH, HEAD — no pin file) ==="
          git clone --depth 1 https://gitlab.com/simonpunk/susfs4ksu.git -b "$SUSFS_BRANCH" "$SUSFS4KSU"
        fi

        SUSFS_PATCHES="$SUSFS4KSU/kernel_patches"
        INJECT_DIR="$GITHUB_WORKSPACE/${{ env.VERSION_DIR }}/susfs"
        chmod +x "$INJECT_DIR"/*.sh

        if [[ "${{ inputs.add_enhanced_susfs }}" == "true" ]]; then
          echo "=== Injecting custom features into upstream SUSFS ==="
          bash "$INJECT_DIR/fix-safety.sh" "$SUSFS_PATCHES"
          bash "$INJECT_DIR/add-kstat-redirect.sh" "$SUSFS_PATCHES"
          bash "$INJECT_DIR/add-open-redirect-all.sh" "$SUSFS_PATCHES"
          bash "$INJECT_DIR/add-unicode-filter-func.sh" "$SUSFS_PATCHES"
          bash "$INJECT_DIR/add-supercall-dispatch.sh" "$SUSFS_PATCHES"
          bash "$INJECT_DIR/add-susfs-zeromount-coupling.sh" "$SUSFS_PATCHES"
        else
          echo "=== Skipping custom SUSFS injection (add_enhanced_susfs=false) ==="
        fi

        echo "=== Applying modified SUSFS to kernel ==="
        cd "$KERNEL_ROOT/common"

        cp "$SUSFS_PATCHES/fs/susfs.c" ./fs/
        cp "$SUSFS_PATCHES/include/linux/"*.h ./include/linux/

        SUSFS_PATCH="$SUSFS_PATCHES/50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch"
        if [ ! -f "$SUSFS_PATCH" ]; then
          echo "ERROR: SUSFS patch not found: $SUSFS_PATCH" && exit 1
        fi

        # Older sublevels have API differences in fdinfo.c — allow partial failure
        PATCH_RC=0
        patch -p1 --no-backup-if-mismatch < "$SUSFS_PATCH" || PATCH_RC=$?
        if [ "$PATCH_RC" -ne 0 ]; then
          echo "  GKI patch had partial hunk failures (exit $PATCH_RC), attempting cross-sublevel fixes..."
        fi

        echo "=== Post-patch: cross-sublevel compat fixes ==="
        HOOKS_DIR="$GITHUB_WORKSPACE/${{ env.VERSION_DIR }}/kernel-hooks"

        # fdinfo.c compat — old vs new inotify API across sublevels
        if [ -x "$HOOKS_DIR/fix-fdinfo-compat.sh" ]; then
          bash "$HOOKS_DIR/fix-fdinfo-compat.sh" "$KERNEL_ROOT/common"
        fi

        # namespace.c/open.c compat — mnt_idmapping.h missing in old sublevels
        if [ -x "$HOOKS_DIR/fix-susfs-include-compat.sh" ]; then
          bash "$HOOKS_DIR/fix-susfs-include-compat.sh" "$KERNEL_ROOT/common"
        fi

        # Hard-fail if unhandled rejects remain
        REMAINING=$(find . -name "*.rej" 2>/dev/null || true)
        if [ -n "$REMAINING" ]; then
          echo "FATAL: Unhandled patch rejects:"
          echo "$REMAINING"
          for f in $REMAINING; do cat "$f"; done
          exit 1
        fi

        if [[ "${{ inputs.add_enhanced_susfs }}" == "true" ]]; then
          echo "=== Post-patch: injecting into kernel source ==="
          bash "$HOOKS_DIR/add-vfs-open-redirect-all.sh" "$KERNEL_ROOT/common"
          bash "$HOOKS_DIR/add-mount-display.sh" "$KERNEL_ROOT/common"

          echo "=== Injecting custom handlers into KernelSU-Next ==="
          bash "$HOOKS_DIR/add-custom-handlers.sh" \
            "$KERNEL_ROOT/${{ env.KSU_DIR }}/kernel/supercalls.c" \
            "$KERNEL_ROOT/common/fs/susfs.c" \
            "$KERNEL_ROOT/${{ env.KSU_DIR }}/kernel/Kconfig" \
            "${{ env.DEFCONFIG }}"
        fi

        if [[ "${{ inputs.add_unicode_filter }}" == "true" ]]; then
          echo "=== Injecting unicode filter VFS hooks ==="
          bash "$HOOKS_DIR/add-unicode-filter.sh" "$KERNEL_ROOT/common"
        fi

        if grep -q 'goto show_pad;' ./fs/proc/task_mmu.c && ! grep -q '^show_pad:' ./fs/proc/task_mmu.c; then
          echo "=== Fixing show_pad label (missing in this sublevel) ==="
          sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
        fi

        echo "=== SUSFS integration complete ==="

    - name: Integrate ZeroMount VFS Path Redirection
      if: inputs.add_zeromount
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Integrating ZeroMount (SUSFS's Spouse!) ==="

        ZEROMOUNT_DIR="$GITHUB_WORKSPACE/${{ env.VERSION_DIR }}/zeromount"

        cd common

        echo "=== Applying ZeroMount core patch ==="
        patch -p1 -F3 --no-backup-if-mismatch < "$ZEROMOUNT_DIR/zeromount-core.patch"

        if [[ -f "fs/zeromount.c" && -f "include/linux/zeromount.h" ]]; then
          echo "SUCCESS: ZeroMount core files created"
        else
          echo "ERROR: ZeroMount core files missing!"
          exit 1
        fi

        echo "=== Running ZeroMount injection scripts ==="
        chmod +x "$ZEROMOUNT_DIR/inject-zeromount-"*.sh

        "$ZEROMOUNT_DIR/inject-zeromount-stat.sh" fs/stat.c
        "$ZEROMOUNT_DIR/inject-zeromount-namei.sh" fs/namei.c
        "$ZEROMOUNT_DIR/inject-zeromount-readdir.sh" fs/readdir.c
        "$ZEROMOUNT_DIR/inject-zeromount-dpath.sh" fs/d_path.c
        "$ZEROMOUNT_DIR/inject-zeromount-statfs.sh" fs/statfs.c
        "$ZEROMOUNT_DIR/inject-zeromount-xattr.sh" fs/xattr.c

        echo "=== All ZeroMount hooks injected ==="

        echo "CONFIG_ZEROMOUNT=y" >> arch/arm64/configs/gki_defconfig

        echo "=== Validating ZeroMount hooks ==="
        grep -q "zeromount_stat_hook" fs/stat.c || { echo "FAIL: stat.c hook missing"; exit 1; }
        grep -q "zeromount_getname_hook" fs/namei.c || { echo "FAIL: namei.c hook missing"; exit 1; }
        grep -q "zeromount_inject_dents64" fs/readdir.c || { echo "FAIL: readdir.c hook missing"; exit 1; }
        grep -q "zeromount_get_virtual_path_for_inode" fs/d_path.c || { echo "FAIL: d_path.c hook missing"; exit 1; }
        grep -q "zeromount_spoof_statfs" fs/statfs.c || { echo "FAIL: statfs.c hook missing"; exit 1; }
        grep -q "zeromount_spoof_xattr" fs/xattr.c || { echo "FAIL: xattr.c hook missing"; exit 1; }
        echo "SUCCESS: All ZeroMount hooks validated"

        echo "=== ZeroMount integration complete ==="

    - name: Fix ZeroMount SUSFS detection bypass
      if: inputs.add_zeromount && inputs.add_susfs
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        chmod +x "$GITHUB_WORKSPACE/${{ env.VERSION_DIR }}/zeromount/fix-zeromount-susfs-bypass.sh"
        bash "$GITHUB_WORKSPACE/${{ env.VERSION_DIR }}/zeromount/fix-zeromount-susfs-bypass.sh" fs/zeromount.c

    - name: Upgrade LZ4 to v1.10.0 with ARM64 NEON
      if: inputs.add_zram
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        echo "=== Upgrading LZ4 to v1.10.0 ==="
        ZRAM_DIR="$GITHUB_WORKSPACE/zram"

        if [ -d "$ZRAM_DIR" ]; then
          rm -f lib/lz4/lz4_compress.c lib/lz4/lz4_decompress.c lib/lz4/lz4defs.h lib/lz4/lz4hc_compress.c

          cp -r "$ZRAM_DIR/lz4/"* ./lib/lz4/ 2>/dev/null || true
          cp -r "$ZRAM_DIR/include/linux/"* ./include/linux/ 2>/dev/null || true

          if [ -f "$ZRAM_DIR/${{ env.KERNEL_VERSION }}/lz4_1.10.0.patch" ]; then
            patch -p1 -F3 < "$ZRAM_DIR/${{ env.KERNEL_VERSION }}/lz4_1.10.0.patch" || echo "LZ4 v1.10.0 patch skipped"
          fi

          if [ -f "lib/lz4/lz4armv8/lz4armv8.S" ]; then
            echo "SUCCESS: LZ4 ARM64 NEON assembly present"
          fi
        else
          echo "Note: zram directory not found, skipping LZ4 v1.10.0 upgrade"
        fi
        echo "=== LZ4 upgrade done ==="

    - name: Add LZ4K/LZ4KD Compression
      if: inputs.add_zram
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        SUKISU="$GITHUB_WORKSPACE/SukiSU_patch"
        KERNEL_VER="${{ env.KERNEL_VERSION }}"

        cp -r "$SUKISU/other/zram/lz4k/include/linux/"* ./include/linux/
        cp -r "$SUKISU/other/zram/lz4k/lib/"* ./lib/
        cp -r "$SUKISU/other/zram/lz4k/crypto/"* ./crypto/
        cp -r "$SUKISU/other/zram/lz4k_oplus" ./lib/

        if [ -f "$SUKISU/other/zram/zram_patch/$KERNEL_VER/lz4kd.patch" ]; then
          patch -p1 -F3 < "$SUKISU/other/zram/zram_patch/$KERNEL_VER/lz4kd.patch"
        fi
        if [ -f "$SUKISU/other/zram/zram_patch/$KERNEL_VER/lz4k_oplus.patch" ]; then
          patch -p1 -F3 < "$SUKISU/other/zram/zram_patch/$KERNEL_VER/lz4k_oplus.patch" || echo "Note: lz4k_oplus patch skipped (optional)"
        fi

    - name: Configure Kernel
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        # Read defconfig from fragment file
        FRAGMENT="$GITHUB_WORKSPACE/${{ env.VERSION_DIR }}/defconfig.fragment"

        # KSU base config (always on)
        awk '/^# \[base\]/{found=1; next} /^# \[/{found=0} found && NF' "$FRAGMENT" >> "${{ env.DEFCONFIG }}"

        # SUSFS config
        if [[ "${{ inputs.add_susfs }}" == "true" ]]; then
          awk '/^# \[susfs\]/{found=1; next} /^# \[/{found=0} found && NF' "$FRAGMENT" >> "${{ env.DEFCONFIG }}"
        fi

        # ZRAM config
        if [[ "${{ inputs.add_zram }}" == "true" ]]; then
          awk '/^# \[zram\]/{found=1; next} /^# \[/{found=0} found && NF' "$FRAGMENT" >> "${{ env.DEFCONFIG }}"
          sed -i 's/CONFIG_ZRAM=m/CONFIG_ZRAM=y/g' "${{ env.DEFCONFIG }}"
          sed -i 's/CONFIG_ZSMALLOC=m/CONFIG_ZSMALLOC=y/g' "${{ env.DEFCONFIG }}"
        fi

        # Dedup: injection scripts and base defconfig may already define some symbols
        tac "${{ env.DEFCONFIG }}" | awk -F= '/^CONFIG_/{if(seen[$1]++)next} {print}' | tac > "${{ env.DEFCONFIG }}.tmp"
        mv "${{ env.DEFCONFIG }}.tmp" "${{ env.DEFCONFIG }}"

        # Disable defconfig check
        if [[ "${{ env.KERNEL_VERSION }}" == "6.12" ]]; then
          sed -i '/name = "kernel_aarch64",/a\    check_defconfig = "disabled",' common/BUILD.bazel
        else
          sed -i 's/check_defconfig//' ./common/build.config.gki
        fi

    - name: Apply Performance Patches
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        echo "=== Applying Performance Patches ==="
        MIN_VERSION="5.16"

        cp "$KERNEL_PATCHES/common/optimized_mem_operations.patch" ./
        patch -p1 --forward < optimized_mem_operations.patch || echo "optimized_mem_operations skipped"

        cp "$KERNEL_PATCHES/common/file_struct_8bytes_align.patch" ./
        patch -p1 --forward < file_struct_8bytes_align.patch || echo "file_struct_8bytes_align skipped"

        cp "$KERNEL_PATCHES/common/reduce_cache_pressure.patch" ./
        patch -p1 --forward < reduce_cache_pressure.patch || echo "reduce_cache_pressure skipped"

        if [[ "$(printf '%s\n' "${{ env.KERNEL_VERSION }}" "$MIN_VERSION" | sort -V | head -n1)" = "${{ env.KERNEL_VERSION }}" ]]; then
          cp "$KERNEL_PATCHES/common/clear_page_16bytes_align.patch" ./
          patch -p1 --forward < clear_page_16bytes_align.patch || echo "clear_page_16bytes_align skipped"
        else
          cp "$KERNEL_PATCHES/common/clear_page_16bytes_align.patch" ./
          sed -e 's/SYM_FUNC_START_PI(clear_page)/SYM_FUNC_START_PI(__pi_clear_page)/' clear_page_16bytes_align.patch > clear_page_16bytes_align__pi.patch
          patch -p1 -F3 --forward < clear_page_16bytes_align__pi.patch || echo "clear_page_16bytes_align__pi skipped"
        fi
        echo "=== Performance Patches Done ==="

    - name: Add BBG (Baseband Guard)
      if: inputs.add_bbg
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Adding BBG ==="
        curl -LSs https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
        echo "CONFIG_BBG=y" >> common/arch/arm64/configs/gki_defconfig
        sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' common/security/Kconfig
        echo "=== BBG Done ==="

    - name: Fix WiFi/BT on Xiaomi 6.6 GKI devices
      if: env.KERNEL_VERSION == '6.6'
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        echo "=== Adding Xiaomi 6.6 WiFi/BT fix ==="
        SYMBOL_LIST=android/abi_gki_aarch64_xiaomi
        if [ -f "$SYMBOL_LIST" ]; then
          echo "device_find_any_child" >> $SYMBOL_LIST
          echo "SUCCESS: Added device_find_any_child to Xiaomi symbol list"
        else
          echo "Note: Xiaomi symbol list not found, skipping"
        fi

    - name: Apply Module Check Bypass
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Applying Module Check Bypass ==="
        if [[ "${{ env.KERNEL_VERSION }}" == "6.1" || "${{ env.KERNEL_VERSION }}" == "6.6" || "${{ env.KERNEL_VERSION }}" == "6.12" ]]; then
          TARGET_FILE="$KERNEL_ROOT/common/kernel/module/version.c"
        else
          TARGET_FILE="$KERNEL_ROOT/common/kernel/module.c"
        fi

        sed -i '/bad_version:/{:a;n;/return 0;/{s/return 0;/return 1;/;b};ba}' "$TARGET_FILE"

        if grep -A 5 "bad_version:" "$TARGET_FILE" | grep -q "return 1;"; then
          echo "SUCCESS: Module check bypass applied"
        else
          echo "WARNING: Module check bypass may not have applied"
        fi
        echo "=== Module Check Bypass Done ==="

    - name: Add Android 16/6.12 ashmem Exports
      if: env.ANDROID_VERSION == 'android16' && env.KERNEL_VERSION == '6.12'
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Adding ashmem exports for Android 16 ==="
        FILE=common/drivers/staging/android/ashmem.c
        if [[ -f "$FILE" ]] && ! grep -q 'is_ashmem_file' "$FILE"; then
          cat >>"$FILE" <<'ASHMEM_EOF'
        bool is_ashmem_file(struct file *file) { return false; }
        int ashmem_area_name(struct file *file, char *name) { return 0; }
        long ashmem_area_size(struct file *file) { return 0; }
        struct file *ashmem_area_vmfile(struct file *file) { return NULL; }
        EXPORT_SYMBOL_GPL(is_ashmem_file);
        EXPORT_SYMBOL_GPL(ashmem_area_name);
        EXPORT_SYMBOL_GPL(ashmem_area_size);
        EXPORT_SYMBOL_GPL(ashmem_area_vmfile);
        ASHMEM_EOF
          sed -i 's/^        //' "$FILE"
          echo "SUCCESS: ashmem exports added"
        fi

        if [ -f common/drivers/android/binder/Makefile ]; then
          perl -i -0777 -pe 's/\$\(\s*CONFIG_ANDROID_BINDER_IPC_RUST\s*\)/m/' common/drivers/android/binder/Makefile
          perl -i -pe 's/^rust_binder-\$\([^)]+\)\s*:=/rust_binder-y :=/' common/drivers/android/binder/Makefile
          rustup set profile minimal
          rustup update nightly
          rustup default nightly
          rustup target add aarch64-unknown-none
        else
          perl -i -0777 -pe 's/\$\(\s*CONFIG_ANDROID_BINDER_IPC_RUST\s*\)/m/' common/drivers/android/Makefile 2>/dev/null || true
        fi
        echo "=== Android 16 ashmem exports done ==="

    - name: Clean Build Flags
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        if [ -f "build/build.sh" ]; then
          sed -i 's/-dirty//' ./common/scripts/setlocalversion
        else
          sed -i "/stable_scmversion_cmd/s/-maybe-dirty//g" ./build/kernel/kleaf/impl/stamp.bzl
          sed -i 's/-dirty//' ./common/scripts/setlocalversion
          rm -rf ./common/android/abi_gki_protected_exports_*
          perl -pi -e 's/^\s*"protected_exports_list"\s*:\s*"android\/abi_gki_protected_exports_aarch64",\s*$//;' ./common/BUILD.bazel
        fi

    - name: Set Stock Build Identity
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        PROFILE_FILE="$GITHUB_WORKSPACE/device-profiles.json"
        INPUT_CODENAME="${{ inputs.device_codename }}"

        if [ -f "$PROFILE_FILE" ] && command -v jq &> /dev/null; then
          # Explicit device_codename takes precedence over auto-discovery
          if [ -n "$INPUT_CODENAME" ] && [ "$INPUT_CODENAME" != "generic" ] && [ "$INPUT_CODENAME" != "" ]; then
            DEVICE_CODENAME="$INPUT_CODENAME"
            echo "=== Using explicit device codename: $DEVICE_CODENAME ==="
          else
            DEVICE_CODENAME=$(jq -r --arg kv "${{ env.KERNEL_VERSION }}" --arg sl "${{ env.ACTUAL_SUBLEVEL }}" \
              '[.devices | to_entries[] | select(.value.kernel_version == $kv and .value.sub_level == $sl) | .key] | first // empty' \
              "$PROFILE_FILE")
          fi

          if [ -z "$DEVICE_CODENAME" ]; then
            echo "No device profile matches ${{ env.KERNEL_VERSION }}.${{ env.ACTUAL_SUBLEVEL }}, using defaults"
            echo "IDENTITY_STATUS=Generic" >> $GITHUB_ENV
          else
            DEVICE_EXISTS=$(jq -r ".devices.${DEVICE_CODENAME} // empty" "$PROFILE_FILE")
          fi

          if [ -n "$DEVICE_CODENAME" ] && [ -n "$DEVICE_EXISTS" ]; then
            echo "=== Auto-discovered device profile: $DEVICE_CODENAME ==="

            STOCK_RELEASE=$(jq -r ".devices.${DEVICE_CODENAME}.stock_kernel.release" "$PROFILE_FILE")
            STOCK_VERSION=$(jq -r ".devices.${DEVICE_CODENAME}.stock_kernel.version_string" "$PROFILE_FILE")
            STOCK_BUILD_USER=$(jq -r ".devices.${DEVICE_CODENAME}.stock_kernel.build_user" "$PROFILE_FILE")
            STOCK_BUILD_HOST=$(jq -r ".devices.${DEVICE_CODENAME}.stock_kernel.build_host" "$PROFILE_FILE")
            STOCK_COMPILER=$(jq -r ".devices.${DEVICE_CODENAME}.stock_kernel.compiler_info // empty" "$PROFILE_FILE")

            echo "Stock release: $STOCK_RELEASE"
            echo "Stock version: $STOCK_VERSION"
            [ -n "$STOCK_COMPILER" ] && echo "Stock compiler: $STOCK_COMPILER"

            cat > scripts/setlocalversion << 'SETLOCAL_EOF'
        #!/bin/sh
        printf '%s' "$STOCK_RELEASE_SUFFIX"
        SETLOCAL_EOF
            sed -i "s|\$STOCK_RELEASE_SUFFIX|${STOCK_RELEASE}|g" scripts/setlocalversion
            chmod +x scripts/setlocalversion

            if [ -f "scripts/mkcompile_h" ]; then
              sed -i "s|UTS_VERSION=.*|UTS_VERSION=\"${STOCK_VERSION}\"|" scripts/mkcompile_h
              if grep -q "LINUX_COMPILE_BY=" scripts/mkcompile_h; then
                sed -i "s|LINUX_COMPILE_BY=.*|LINUX_COMPILE_BY=\"${STOCK_BUILD_USER}\"|" scripts/mkcompile_h
                sed -i "s|LINUX_COMPILE_HOST=.*|LINUX_COMPILE_HOST=\"${STOCK_BUILD_HOST}\"|" scripts/mkcompile_h
              fi
              if [ -n "$STOCK_COMPILER" ] && grep -q "LINUX_COMPILER=" scripts/mkcompile_h; then
                sed -i "s|LINUX_COMPILER=.*|LINUX_COMPILER=\"${STOCK_COMPILER}\"|" scripts/mkcompile_h
              fi
            fi

            echo "KBUILD_BUILD_USER=$STOCK_BUILD_USER" >> $GITHUB_ENV
            echo "KBUILD_BUILD_HOST=$STOCK_BUILD_HOST" >> $GITHUB_ENV
            echo "IDENTITY_STATUS=Applied ($DEVICE_CODENAME)" >> $GITHUB_ENV
          else
            echo "WARNING: Device $DEVICE_CODENAME not found in profiles, using defaults"
            echo "IDENTITY_STATUS=Generic" >> $GITHUB_ENV
          fi
        else
          echo "WARNING: device-profiles.json not found or jq not available"
          echo "IDENTITY_STATUS=Generic" >> $GITHUB_ENV
        fi

    - name: Commit Changes
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add .
        git commit -m "Apply KernelSU-Next + SUSFS + Stock Identity" || true

    - name: Build Kernel
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        # ZRAM is built-in (=y), remove from expected-modules list so build.sh check passes
        sed -i '/zsmalloc\.ko/d; /zram\.ko/d' common/android/gki_aarch64_modules 2>/dev/null || true

        if [ -f "build/build.sh" ]; then
          HOSTLD=ld.lld LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh || exit 1
        else
          tools/bazel build --config=fast --config=stamp --lto=thin //common:kernel_aarch64_dist || exit 1
        fi

    - name: Prepare AnyKernel3 Zip
      run: |
        if [ -f "$KERNEL_ROOT/out/${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}/dist/Image" ]; then
          cp "$KERNEL_ROOT/out/${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}/dist/Image" "$ANYKERNEL3/Image"
        elif [ -f "$KERNEL_ROOT/bazel-bin/common/kernel_aarch64/Image" ]; then
          cp "$KERNEL_ROOT/bazel-bin/common/kernel_aarch64/Image" "$ANYKERNEL3/Image"
        else
          echo "ERROR: Cannot find kernel Image"
          find $KERNEL_ROOT -name "Image" -type f 2>/dev/null || true
          exit 1
        fi

    - name: Create ZRAM Module (Full Version)
      if: inputs.add_zram
      run: |
        echo "=== Creating KSU ZRAM module ==="
        ZRAM_MOD="$ANYKERNEL3/modules/data/adb/modules/zram_config"
        mkdir -p "$ZRAM_MOD/META-INF/com/google/android"

        cat > "$ZRAM_MOD/module.prop" << 'MODPROP'
        id=zram_config
        name=ZRAM 8GB LZ4 Configuration
        version=1.0
        versionCode=1
        author=Enginex0
        description=Configures ZRAM with 8GB size and LZ4 compression at boot. Compatible with Magisk/KernelSU.
        MODPROP
        sed -i 's/^        //' "$ZRAM_MOD/module.prop"

        cat > "$ZRAM_MOD/service.sh" << 'SERVICESH'
        #!/system/bin/sh
        MODDIR=${0%/*}
        LOG="$MODDIR/zram.log"

        log() {
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG"
        }

        ZRAM_SIZE=8589934592
        ZRAM_ALGO=lz4
        MAX_STREAMS=8

        log "========================================="
        log "=== ZRAM Configuration Service Start ==="
        log "========================================="

        log "Waiting for system initialization..."
        sleep 30

        log "Stopping existing ZRAM swap..."
        swapoff /dev/block/zram0 2>/dev/null
        sleep 2

        log "Resetting ZRAM device..."
        echo 1 > /sys/block/zram0/reset 2>/dev/null
        sleep 1

        log "Setting max_comp_streams: $MAX_STREAMS"
        echo "$MAX_STREAMS" > /sys/block/zram0/max_comp_streams 2>/dev/null

        log "Setting compression algorithm: $ZRAM_ALGO"
        echo "$ZRAM_ALGO" > /sys/block/zram0/comp_algorithm 2>/dev/null

        log "Setting disksize: $ZRAM_SIZE bytes (8GB)"
        echo "$ZRAM_SIZE" > /sys/block/zram0/disksize 2>/dev/null

        log "Initializing swap partition..."
        mkswap /dev/block/zram0 > /dev/null 2>&1

        log "Enabling swap..."
        swapon /dev/block/zram0 > /dev/null 2>&1

        ACTUAL_SIZE=$(cat /sys/block/zram0/disksize 2>/dev/null)
        ACTUAL_ALGO=$(cat /sys/block/zram0/comp_algorithm 2>/dev/null | grep -o '\[.*\]' | tr -d '[]')
        [ -z "$ACTUAL_ALGO" ] && ACTUAL_ALGO=$(cat /sys/block/zram0/comp_algorithm 2>/dev/null)

        log "----------------------------------------"
        log "ZRAM Configuration Result:"
        log "  Size: $ACTUAL_SIZE bytes"
        log "  Algorithm: $ACTUAL_ALGO"
        log "----------------------------------------"

        MEM_INFO=$(free -h 2>/dev/null | grep -E "Mem:|Swap:")
        log "Memory Status:"
        log "$MEM_INFO"

        log "=== ZRAM Configuration Complete ==="
        SERVICESH
        sed -i 's/^        //' "$ZRAM_MOD/service.sh"
        chmod +x "$ZRAM_MOD/service.sh"

        cat > "$ZRAM_MOD/customize.sh" << 'CUSTOMIZESH'
        #!/system/bin/sh
        ui_print "========================================="
        ui_print "   ZRAM 8GB LZ4 Configuration Module"
        ui_print "   Author: Enginex0"
        ui_print "========================================="
        ui_print ""
        ui_print "Configuration:"
        ui_print "  - ZRAM Size: 8GB"
        ui_print "  - Algorithm: LZ4"
        ui_print "  - Streams: 8"
        ui_print ""
        ui_print "The module will configure ZRAM at boot."
        ui_print ""
        set_perm_recursive $MODPATH 0 0 0755 0644
        set_perm $MODPATH/service.sh 0 0 0755
        CUSTOMIZESH
        sed -i 's/^        //' "$ZRAM_MOD/customize.sh"
        chmod +x "$ZRAM_MOD/customize.sh"

        echo '#MAGISK' > "$ZRAM_MOD/META-INF/com/google/android/updater-script"

        cat > "$ZRAM_MOD/META-INF/com/google/android/update-binary" << 'UPDATEBIN'
        #!/sbin/sh
        umask 022
        TMPDIR=/dev/tmp
        rm -rf $TMPDIR 2>/dev/null
        mkdir -p $TMPDIR
        ui_print() { echo "$1"; }
        require_new_magisk() {
          ui_print "*******************************"
          ui_print " Please install Magisk v20.4+! "
          ui_print "*******************************"
          exit 1
        }
        OUTFD=$2
        ZIPFILE=$3
        mount /data 2>/dev/null
        [ -f /data/adb/magisk/util_functions.sh ] || require_new_magisk
        . /data/adb/magisk/util_functions.sh
        [ $MAGISK_VER_CODE -lt 20400 ] && require_new_magisk
        setup_flashable
        mount_partitions
        api_level_arch_detect
        $BOOTMODE && boot_actions || recovery_actions
        unzip -o "$ZIPFILE" module.prop -d $TMPDIR >&2
        [ ! -f $TMPDIR/module.prop ] && abort "! Unable to extract zip file!"
        $BOOTMODE && MODDIRNAME=modules_update || MODDIRNAME=modules
        MODULEROOT=$NVBASE/$MODDIRNAME
        MODID=$(grep_prop id $TMPDIR/module.prop)
        MODPATH=$MODULEROOT/$MODID
        rm -rf $MODPATH 2>/dev/null
        mkdir -p $MODPATH
        ui_print "- Extracting module files"
        unzip -o "$ZIPFILE" -d $MODPATH >&2
        rm -rf $MODPATH/META-INF 2>/dev/null
        set_perm_recursive $MODPATH 0 0 0755 0644
        [ -f $MODPATH/service.sh ] && set_perm $MODPATH/service.sh 0 0 0755
        $BOOTMODE && {
          mktouch $NVBASE/modules/$MODID/update
          cp -af $MODPATH/module.prop $NVBASE/modules/$MODID/module.prop
        }
        [ -f $MODPATH/sepolicy.rule ] && {
          ui_print "- Installing custom sepolicy rules"
          copy_sepolicy_rules
        }
        cd /
        $BOOTMODE || recovery_cleanup
        rm -rf $TMPDIR
        ui_print "- Done"
        exit 0
        UPDATEBIN
        sed -i 's/^        //' "$ZRAM_MOD/META-INF/com/google/android/update-binary"
        chmod +x "$ZRAM_MOD/META-INF/com/google/android/update-binary"

        echo "=== ZRAM module created ==="

    - name: Scan and Collect Patch Rejects
      if: always()
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Scanning for patch reject files ==="
        REJECTS_DIR="$GITHUB_WORKSPACE/patch-rejects"
        mkdir -p "$REJECTS_DIR"
        mapfile -t REJS < <(find . -type f -name '*.rej')
        REJ_COUNT=${#REJS[@]}
        echo "Found $REJ_COUNT .rej files"
        echo "REJ_COUNT=$REJ_COUNT" >> $GITHUB_ENV
        if [ "$REJ_COUNT" -gt 0 ]; then
          for REJ in "${REJS[@]}"; do
            REL="${REJ#./}"
            DEST="$REJECTS_DIR/$REL"
            mkdir -p "$(dirname "$DEST")"
            cp "$REJ" "$DEST"
            ORIG="${REJ%.rej}"
            if [ -f "$ORIG" ]; then
              ORIG_DEST="$REJECTS_DIR/${REL%.rej}"
              mkdir -p "$(dirname "$ORIG_DEST")"
              cp "$ORIG" "$ORIG_DEST"
            fi
          done
          echo "## Patch Rejects Found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          printf '%s\n' "${REJS[@]}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "No patch rejects found"
        fi

    - name: Upload Rejects
      if: always() && env.REJ_COUNT > 0
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FILE_NAME }}-Rejects
        path: patch-rejects/
        if-no-files-found: ignore
        compression-level: 9

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FILE_NAME }}-AnyKernel3
        path: ./AnyKernel3/**
        compression-level: 9

    - name: Build Summary
      run: |
        S() { [[ "$1" == "true" ]] && echo "Enabled" || echo "Disabled"; }

        echo "## ${{ inputs.ksu_variant }} | ${{ env.KERNEL_VERSION }}.${{ env.ACTUAL_SUBLEVEL }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Feature | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Kernel** | ${{ env.KERNEL_VERSION }}.${{ env.ACTUAL_SUBLEVEL }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Android** | ${{ env.ANDROID_VERSION }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **KSU Variant** | ${{ inputs.ksu_variant }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **OS Patch Level** | ${{ env.OS_PATCH_LEVEL }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **SUSFS** | $(S ${{ inputs.add_susfs }}) |" >> $GITHUB_STEP_SUMMARY
        echo "| **Enhanced SUSFS** | $(S ${{ inputs.add_enhanced_susfs }}) |" >> $GITHUB_STEP_SUMMARY
        echo "| **Unicode Filter** | $(S ${{ inputs.add_unicode_filter }}) |" >> $GITHUB_STEP_SUMMARY
        echo "| **ZeroMount** | $(S ${{ inputs.add_zeromount }}) |" >> $GITHUB_STEP_SUMMARY
        echo "| **ZRAM (LZ4K)** | $(S ${{ inputs.add_zram }}) |" >> $GITHUB_STEP_SUMMARY
        echo "| **Baseband Guard** | $(S ${{ inputs.add_bbg }}) |" >> $GITHUB_STEP_SUMMARY
        echo "| **Device Profile** | ${{ env.IDENTITY_STATUS }} |" >> $GITHUB_STEP_SUMMARY
