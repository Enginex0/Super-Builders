name: GKI Build (WildKernels Base)

permissions:
  contents: write
  actions: write

on:
  workflow_call:
    inputs:
      android_version:
        type: string
        required: true
      kernel_version:
        type: string
        required: true
      sub_level:
        type: string
        required: true
      os_patch_level:
        type: string
        required: true
      ksu_variant:
        type: string
        default: "KernelSU-Next"
      add_susfs:
        type: boolean
        default: true
      add_enhanced_susfs:
        type: boolean
        default: true
      add_zeromount:
        type: boolean
        default: true
      add_bbg:
        type: boolean
        default: true
      add_zram:
        type: boolean
        default: false
      add_overlayfs_support:
        type: boolean
        default: true
      add_kpm:
        type: boolean
        default: false
      add_unicode_filter:
        type: boolean
        default: true
      device_codename:
        type: string
        default: ""

jobs:
  build:
    name: "${{ inputs.ksu_variant }} ${{ inputs.kernel_version }}.${{ inputs.sub_level }}"
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Free Disk Space
      uses: endersonmenezes/free-disk-space@v3
      with:
        remove_android: true
        remove_dotnet: true
        remove_haskell: true
        remove_tool_cache: true
        remove_swap: true
        remove_packages: "azure-cli google-cloud-cli microsoft-edge-stable google-chrome-stable firefox postgresql* temurin-* *llvm* mysql* dotnet-sdk-*"
        remove_packages_one_command: true
        remove_folders: "/usr/share/swift /usr/share/miniconda /usr/share/az* /usr/local/lib/node_modules /usr/local/share/chromium /usr/local/share/powershell /usr/local/julia /usr/local/aws-cli /usr/local/aws-sam-cli /usr/share/gradle"
        rm_cmd: "rmz"
        rmz_version: "3.1.1"
        testing: false

    - name: Download AnyKernel3 Artifact
      uses: actions/download-artifact@v4
      with:
        name: anykernel3
        path: AnyKernel3

    - name: Download Kernel Patches Artifact
      uses: actions/download-artifact@v4
      with:
        name: kernel-patches
        path: kernel_patches

    - name: Download Git Repo Tool Artifact
      uses: actions/download-artifact@v4
      with:
        name: git-repo-tool
        path: git-repo

    - name: Download SukiSU Patch
      if: inputs.add_zram
      uses: actions/download-artifact@v4
      with:
        name: sukisu-patch
        path: SukiSU_patch

    - name: Setup Build Environment
      env:
        ANDROID_VER: ${{ inputs.android_version }}
        KERNEL_VER: ${{ inputs.kernel_version }}
        SUB_LEVEL: ${{ inputs.sub_level }}
      run: |
        CONFIG="${ANDROID_VER}-${KERNEL_VER}-${SUB_LEVEL}"
        KERNEL_ROOT="$GITHUB_WORKSPACE/$CONFIG"
        VERSION_DIR="${ANDROID_VER}-${KERNEL_VER}"
        mkdir -p "$KERNEL_ROOT"

        chmod +x "$GITHUB_WORKSPACE/git-repo/repo"
        echo "$GITHUB_WORKSPACE/git-repo" >> "$GITHUB_PATH"

        {
          echo "CONFIG=$CONFIG"
          echo "KERNEL_ROOT=$KERNEL_ROOT"
          echo "VERSION_DIR=$VERSION_DIR"
          echo "DEFCONFIG=$KERNEL_ROOT/common/arch/arm64/configs/gki_defconfig"
          echo "DEFCONFIG_FRAGMENT=$KERNEL_ROOT/common/arch/arm64/configs/wild_gki.fragment"
          echo "SUSFS4KSU=$GITHUB_WORKSPACE/susfs4ksu"
          echo "KERNEL_PATCHES=$GITHUB_WORKSPACE/kernel_patches"
          echo "ANYKERNEL3=$GITHUB_WORKSPACE/AnyKernel3"
        } >> "$GITHUB_ENV"

    - name: Sync Kernel Source
      working-directory: ${{ env.KERNEL_ROOT }}
      env:
        ANDROID_VER: ${{ inputs.android_version }}
        KERNEL_VER: ${{ inputs.kernel_version }}
        OS_PATCH: ${{ inputs.os_patch_level }}
      run: |
        FORMATTED_BRANCH="${ANDROID_VER}-${KERNEL_VER}-${OS_PATCH}"

        repo init -u https://android.googlesource.com/kernel/manifest \
          -b "common-${FORMATTED_BRANCH}" --depth=1

        REMOTE_BRANCH=$(git ls-remote https://android.googlesource.com/kernel/common "${FORMATTED_BRANCH}")
        if grep -q deprecated <<< "$REMOTE_BRANCH"; then
          sed -i "s/\"${FORMATTED_BRANCH}\"/\"deprecated\/${FORMATTED_BRANCH}\"/g" .repo/manifests/default.xml
          echo "DEPRECATED_BRANCH=true" >> "$GITHUB_ENV"
        fi

        repo --trace sync -c -j$(nproc --all) --fail-fast --no-tags --force-sync --no-clone-bundle

    - name: Extract Sublevel
      env:
        INPUT_SUB_LEVEL: ${{ inputs.sub_level }}
        KSU_VARIANT: ${{ inputs.ksu_variant }}
        KERNEL_VER: ${{ inputs.kernel_version }}
        ANDROID_VER: ${{ inputs.android_version }}
        OS_PATCH: ${{ inputs.os_patch_level }}
      run: |
        SUBLEVEL="$INPUT_SUB_LEVEL"
        if [[ -f "$KERNEL_ROOT/common/Makefile" ]]; then
          EXTRACTED=$(grep '^SUBLEVEL = ' "$KERNEL_ROOT/common/Makefile" | awk '{print $3}')
          [[ -n "$EXTRACTED" ]] && SUBLEVEL="$EXTRACTED"
        fi

        ARTIFACT_BASE="${KERNEL_VER}.${SUBLEVEL}-${ANDROID_VER}-${OS_PATCH}-${KSU_VARIANT}-SUSFS"
        {
          echo "SUBLEVEL=$SUBLEVEL"
          echo "ARTIFACT_BASE=$ARTIFACT_BASE"
          echo "FILE_NAME=$ARTIFACT_BASE"
        } >> "$GITHUB_ENV"

    - name: Apply glibc 2.38 Compatibility Fix
      env:
        ANDROID_VER: ${{ inputs.android_version }}
        KERNEL_VER: ${{ inputs.kernel_version }}
      run: |
        SL="$SUBLEVEL"
        if [[ "$ANDROID_VER" == "android13" && "$KERNEL_VER" == "5.10" && $SL -le 186 ]] ||
           [[ "$ANDROID_VER" == "android13" && "$KERNEL_VER" == "5.15" && $SL -le 119 ]] ||
           [[ "$ANDROID_VER" == "android14" && "$KERNEL_VER" == "5.15" && $SL -le 110 ]] ||
           [[ "$ANDROID_VER" == "android14" && "$KERNEL_VER" == "6.1" && $SL -le 43 ]]; then
          GLIBC_VERSION=$(ldd --version 2>/dev/null | head -n 1 | awk '{print $NF}')
          if [ "$(printf '%s\n' "2.38" "$GLIBC_VERSION" | sort -V | head -n1)" = "2.38" ]; then
            cd "$KERNEL_ROOT/common"
            sed -i '/\$(Q)\$(MAKE) -C \$(SUBCMD_SRC) OUTPUT=\$(abspath \$(dir \$@))\/ \$(abspath \$@)/s//$(Q)$(MAKE) -C $(SUBCMD_SRC) EXTRA_CFLAGS="$(CFLAGS)" OUTPUT=$(abspath $(dir $@))\/ $(abspath $@)/' tools/bpf/resolve_btfids/Makefile 2>/dev/null || true
            if [[ "$ANDROID_VER" == "android13" && "$KERNEL_VER" == "5.10" && $SL -le 186 ]] ||
               [[ "$ANDROID_VER" == "android13" && "$KERNEL_VER" == "5.15" && $SL -le 119 ]] ||
               [[ "$ANDROID_VER" == "android14" && "$KERNEL_VER" == "5.15" && $SL -le 110 ]]; then
              sed -i '/char \*buf = NULL;/a int i;' tools/lib/subcmd/parse-options.c 2>/dev/null || true
              sed -i 's/for (int i = 0; subcommands\[i\]; i++) {/for (i = 0; subcommands[i]; i++) {/' tools/lib/subcmd/parse-options.c 2>/dev/null || true
              sed -i '/if (subcommands) {/a int i;' tools/lib/subcmd/parse-options.c 2>/dev/null || true
              sed -i 's/for (int i = 0; subcommands\[i\]; i++)/for (i = 0; subcommands[i]; i++)/' tools/lib/subcmd/parse-options.c 2>/dev/null || true
            fi
          fi
        fi

    - name: Fix Android 15 6.6 fs.h include
      if: inputs.android_version == 'android15' && inputs.kernel_version == '6.6'
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        if ! grep -qxF '#include <trace/hooks/fs.h>' ./fs/namespace.c; then
          sed -i '/#include <trace\/hooks\/blk.h>/a #include <trace\/hooks\/fs.h>' ./fs/namespace.c
        fi

    - name: Setup KernelSU
      working-directory: ${{ env.KERNEL_ROOT }}
      env:
        KSU_VARIANT: ${{ inputs.ksu_variant }}
        ADD_SUSFS: ${{ inputs.add_susfs }}
      run: |
        if [[ "$KSU_VARIANT" == "WKSU" ]]; then
          curl -LSs "https://raw.githubusercontent.com/WildKernels/Wild_KSU/stable/kernel/setup.sh" | bash -s canary
          echo "KSU_DIR=Wild_KSU" >> "$GITHUB_ENV"
        elif [[ "$KSU_VARIANT" == "SukiSU" ]]; then
          BRANCH="main"
          [[ "$ADD_SUSFS" == "true" ]] && BRANCH="builtin"
          curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/main/kernel/setup.sh" | bash -s "$BRANCH"
          echo "KSU_DIR=KernelSU" >> "$GITHUB_ENV"
        elif [[ "$KSU_VARIANT" == "ReSukiSU" ]]; then
          BRANCH="main"
          [[ "$ADD_SUSFS" == "true" ]] && BRANCH="susfs-ksud"
          curl -LSs "https://raw.githubusercontent.com/ReSukiSU/ReSukiSU/main/kernel/setup.sh" | bash -s "$BRANCH"
          echo "KSU_DIR=KernelSU" >> "$GITHUB_ENV"
        else
          BRANCH="next"
          [[ "$ADD_SUSFS" == "true" ]] && BRANCH="dev_susfs"
          curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/${BRANCH}/kernel/setup.sh" | bash -s "$BRANCH"
          echo "KSU_DIR=KernelSU-Next" >> "$GITHUB_ENV"
        fi

    - name: Clone SUSFS
      if: inputs.add_susfs
      env:
        ANDROID_VER: ${{ inputs.android_version }}
        KERNEL_VER: ${{ inputs.kernel_version }}
        ADD_ENHANCED: ${{ inputs.add_enhanced_susfs }}
      run: |
        INJECT_DIR="$GITHUB_WORKSPACE/$VERSION_DIR/susfs"
        SUSFS_BRANCH="gki-${ANDROID_VER}-${KERNEL_VER}"

        if [[ "$ADD_ENHANCED" == "true" ]] && [ -f "$INJECT_DIR/patch-gki.sh" ]; then
          SUSFS_PIN_FILE="$GITHUB_WORKSPACE/$VERSION_DIR/susfs-pin.txt"
          if [ -f "$SUSFS_PIN_FILE" ] && [ -s "$SUSFS_PIN_FILE" ]; then
            SUSFS_PIN=$(tr -d '[:space:]' < "$SUSFS_PIN_FILE")
            git clone "https://github.com/Enginex0/susfs4ksu.git" -b "$SUSFS_BRANCH" "$SUSFS4KSU"
            git -C "$SUSFS4KSU" checkout "$SUSFS_PIN" 2>/dev/null || true
          else
            git clone --depth 1 "https://github.com/Enginex0/susfs4ksu.git" -b "$SUSFS_BRANCH" "$SUSFS4KSU"
          fi
        else
          git clone --depth 1 "https://gitlab.com/simonpunk/susfs4ksu.git" -b "$SUSFS_BRANCH" "$SUSFS4KSU"
        fi

    - name: Enhanced SUSFS Pre-Patch
      if: inputs.add_susfs && inputs.add_enhanced_susfs
      env:
        KSU_DIR: ${{ env.KSU_DIR }}
        KSU_VARIANT: ${{ inputs.ksu_variant }}
        ANDROID_VER: ${{ inputs.android_version }}
        KERNEL_VER: ${{ inputs.kernel_version }}
      run: |
        INJECT_DIR="$GITHUB_WORKSPACE/$VERSION_DIR/susfs"
        SUSFS_PATCHES="$SUSFS4KSU/kernel_patches"
        SUSFS_PATCH="$SUSFS_PATCHES/50_add_susfs_in_gki-${ANDROID_VER}-${KERNEL_VER}.patch"
        chmod +x "$INJECT_DIR/"*.sh

        [ -f "$INJECT_DIR/patch-gki.sh" ] && bash "$INJECT_DIR/patch-gki.sh" "$SUSFS_PATCHES" "$KERNEL_ROOT/$KSU_DIR"
        [ -f "$INJECT_DIR/fix-safety.sh" ] && bash "$INJECT_DIR/fix-safety.sh" "$SUSFS_PATCHES" "$KERNEL_ROOT/$KSU_DIR" "$KSU_VARIANT"
        [ -f "$INJECT_DIR/add-features.sh" ] && bash "$INJECT_DIR/add-features.sh" "$SUSFS_PATCHES"
        [ -f "$INJECT_DIR/fix-perf.sh" ] && bash "$INJECT_DIR/fix-perf.sh" "$KERNEL_ROOT/common" "$SUSFS_PATCHES" "$SUSFS_PATCH"

    - name: Apply SUSFS to Kernel
      if: inputs.add_susfs
      working-directory: ${{ env.KERNEL_ROOT }}/common
      env:
        ANDROID_VER: ${{ inputs.android_version }}
        KERNEL_VER: ${{ inputs.kernel_version }}
      run: |
        SUSFS_PATCHES="$SUSFS4KSU/kernel_patches"

        cp "$SUSFS_PATCHES/fs/"* ./fs/
        cp "$SUSFS_PATCHES/include/linux/"*.h ./include/linux/

        patch -p1 --no-backup-if-mismatch < "$SUSFS_PATCHES/50_add_susfs_in_gki-${ANDROID_VER}-${KERNEL_VER}.patch" || true

    - name: Apply SUSFS Version-Specific Fixes
      if: inputs.add_susfs
      working-directory: ${{ env.KERNEL_ROOT }}/common
      env:
        ANDROID_VER: ${{ inputs.android_version }}
        KERNEL_VER: ${{ inputs.kernel_version }}
        OS_PATCH: ${{ inputs.os_patch_level }}
      run: |
        SL="$SUBLEVEL"

        # show_pad label fix (WildKernels exact logic per version)
        if [[ "$ANDROID_VER" == "android12" && "$KERNEL_VER" == "5.10" && $SL -le 209 ]]; then
          sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
        fi
        if [[ "$ANDROID_VER" == "android13" && "$KERNEL_VER" == "5.10" && $SL -le 209 && "$OS_PATCH" != "2024-05" ]]; then
          sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
        fi
        if [[ "$ANDROID_VER" == "android13" && "$KERNEL_VER" == "5.15" && $SL -le 148 && "$OS_PATCH" != "2024-05" ]]; then
          sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
        fi
        if [[ "$ANDROID_VER" == "android14" && "$KERNEL_VER" == "5.15" && $SL -le 148 && "$OS_PATCH" != "2024-05" ]]; then
          sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
        fi
        if [[ "$ANDROID_VER" == "android14" && "$KERNEL_VER" == "6.1" && $SL -le 75 && "$OS_PATCH" != "2024-05" ]]; then
          sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
        fi

        # fdinfo / base.c fixes for old sublevels
        if [[ "$ANDROID_VER" == "android12" && "$KERNEL_VER" == "5.10" && $SL -le 117 ]]; then
          [ -f "$KERNEL_PATCHES/wild/susfs_fix_patches/v2.0.0/a12-5.10/fdinfo.c.patch" ] && \
            patch -p1 < "$KERNEL_PATCHES/wild/susfs_fix_patches/v2.0.0/a12-5.10/fdinfo.c.patch" || true
        fi
        if [[ "$ANDROID_VER" == "android12" && "$KERNEL_VER" == "5.10" && $SL -le 43 ]]; then
          [ -f "$KERNEL_PATCHES/wild/susfs_fix_patches/v2.0.0/a12-5.10/base.c.patch" ] && \
            patch -p1 < "$KERNEL_PATCHES/wild/susfs_fix_patches/v2.0.0/a12-5.10/base.c.patch" || true
        fi
        if [[ "$ANDROID_VER" == "android13" && "$KERNEL_VER" == "5.10" && $SL -le 107 ]]; then
          [ -f "$KERNEL_PATCHES/wild/susfs_fix_patches/v2.0.0/a13-5.10/fdinfo.c.patch" ] && \
            patch -p1 < "$KERNEL_PATCHES/wild/susfs_fix_patches/v2.0.0/a13-5.10/fdinfo.c.patch" || true
        fi
        if [[ "$ANDROID_VER" == "android13" && "$KERNEL_VER" == "5.15" && $SL -le 41 ]]; then
          for P in namespace.c.patch fdinfo.c.patch open.c.patch; do
            [ -f "$KERNEL_PATCHES/wild/susfs_fix_patches/v2.0.0/a13-5.15/$P" ] && \
              patch -p1 < "$KERNEL_PATCHES/wild/susfs_fix_patches/v2.0.0/a13-5.15/$P" || true
          done
          sed -i 's|is_i_uid_not_allowed(i_uid_into_mnt(i_user_ns(inode), inode).val)))|is_i_uid_not_allowed(inode->i_uid.val)))|g' fs/susfs.c
        fi
        if [[ "$ANDROID_VER" == "android15" && "$KERNEL_VER" == "6.6" && $SL -ge 98 ]]; then
          [ -f "$KERNEL_PATCHES/wild/susfs_fix_patches/v2.0.0/a15-6.6/base.c.patch" ] && \
            patch -p1 < "$KERNEL_PATCHES/wild/susfs_fix_patches/v2.0.0/a15-6.6/base.c.patch" || true
        fi
        if [[ "$ANDROID_VER" == "android15" && "$KERNEL_VER" == "6.6" && $SL -le 58 ]]; then
          [ -f "$KERNEL_PATCHES/wild/susfs_fix_patches/v2.0.0/a15-6.6/task_mmu.c.patch" ] && \
            patch -p1 < "$KERNEL_PATCHES/wild/susfs_fix_patches/v2.0.0/a15-6.6/task_mmu.c.patch" || true
        fi

    - name: Enhanced SUSFS Post-Patch
      if: inputs.add_susfs && inputs.add_enhanced_susfs
      env:
        KSU_DIR: ${{ env.KSU_DIR }}
      run: |
        HOOKS_DIR="$GITHUB_WORKSPACE/$VERSION_DIR/kernel-hooks"

        [ -x "$HOOKS_DIR/patch-fdinfo-compat.sh" ] && bash "$HOOKS_DIR/patch-fdinfo-compat.sh" "$KERNEL_ROOT/common"

        bash "$HOOKS_DIR/patch-kernel-sources.sh" \
          "$KERNEL_ROOT/common" \
          "$KERNEL_ROOT/$KSU_DIR/kernel/supercalls.c" \
          "$KERNEL_ROOT/common/fs/susfs.c"

        bash "$HOOKS_DIR/patch-config.sh" \
          "$KERNEL_ROOT/common" \
          "$KERNEL_ROOT/common/fs/susfs.c" \
          "$KERNEL_ROOT/$KSU_DIR/kernel/Kconfig" \
          "$DEFCONFIG"

    - name: Integrate ZeroMount
      if: inputs.add_zeromount
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        ZEROMOUNT_DIR="$GITHUB_WORKSPACE/$VERSION_DIR/zeromount"

        patch -p1 -F3 --no-backup-if-mismatch < "$ZEROMOUNT_DIR/zeromount-core.patch"

        chmod +x "$ZEROMOUNT_DIR/"*.sh
        bash "$ZEROMOUNT_DIR/inject-zeromount-vfs.sh" .
        bash "$ZEROMOUNT_DIR/inject-zeromount-proc.sh" .

        echo "CONFIG_ZEROMOUNT=y" >> arch/arm64/configs/gki_defconfig

    - name: Fix ZeroMount SUSFS Coupling
      if: inputs.add_zeromount && inputs.add_susfs
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        FIX="$GITHUB_WORKSPACE/$VERSION_DIR/zeromount/fix-zeromount-susfs.sh"
        [ -x "$FIX" ] && bash "$FIX" fs/zeromount.c

    - name: Setup Baseband Guard
      if: inputs.add_bbg
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        curl -LSs https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
        echo "CONFIG_BBG=y" >> "$DEFCONFIG"
        sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' common/security/Kconfig

    - name: Upgrade LZ4 to v1.10.0
      if: inputs.add_zram
      working-directory: ${{ env.KERNEL_ROOT }}/common
      env:
        KERNEL_VER: ${{ inputs.kernel_version }}
      run: |
        ZRAM_DIR="$GITHUB_WORKSPACE/zram"
        if [ -d "$ZRAM_DIR" ]; then
          rm -f lib/lz4/lz4_compress.c lib/lz4/lz4_decompress.c lib/lz4/lz4defs.h lib/lz4/lz4hc_compress.c
          cp -r "$ZRAM_DIR/lz4/"* ./lib/lz4/ 2>/dev/null || true
          cp -r "$ZRAM_DIR/include/linux/"* ./include/linux/ 2>/dev/null || true
          [ -f "$ZRAM_DIR/$KERNEL_VER/lz4_1.10.0.patch" ] && patch -p1 -F3 < "$ZRAM_DIR/$KERNEL_VER/lz4_1.10.0.patch" || true
        fi

    - name: Add LZ4K/LZ4KD Compression
      if: inputs.add_zram
      working-directory: ${{ env.KERNEL_ROOT }}/common
      env:
        KERNEL_VER: ${{ inputs.kernel_version }}
      run: |
        SUKISU="$GITHUB_WORKSPACE/SukiSU_patch"

        cp -r "$SUKISU/other/zram/lz4k/include/linux/"* ./include/linux/
        cp -r "$SUKISU/other/zram/lz4k/lib/"* ./lib/
        cp -r "$SUKISU/other/zram/lz4k/crypto/"* ./crypto/
        cp -r "$SUKISU/other/zram/lz4k_oplus" ./lib/

        [ -f "$SUKISU/other/zram/zram_patch/$KERNEL_VER/lz4kd.patch" ] && patch -p1 -F3 < "$SUKISU/other/zram/zram_patch/$KERNEL_VER/lz4kd.patch" || true
        [ -f "$SUKISU/other/zram/zram_patch/$KERNEL_VER/lz4k_oplus.patch" ] && patch -p1 -F3 < "$SUKISU/other/zram/zram_patch/$KERNEL_VER/lz4k_oplus.patch" || true

    - name: Configure Kernel
      working-directory: ${{ env.KERNEL_ROOT }}
      env:
        ANDROID_VER: ${{ inputs.android_version }}
        KERNEL_VER: ${{ inputs.kernel_version }}
        ADD_SUSFS: ${{ inputs.add_susfs }}
        ADD_ZRAM: ${{ inputs.add_zram }}
        ADD_OVERLAYFS: ${{ inputs.add_overlayfs_support }}
        ADD_KPM: ${{ inputs.add_kpm }}
        KSU_VARIANT: ${{ inputs.ksu_variant }}
      run: |
        FRAGMENT="$GITHUB_WORKSPACE/$VERSION_DIR/defconfig.fragment"

        # Read sections from our defconfig.fragment â†’ write to wild_gki.fragment
        awk '/^# \[base\]/{found=1; next} /^# \[/{found=0} found && NF' "$FRAGMENT" >> "$DEFCONFIG_FRAGMENT"

        if [[ "$ADD_SUSFS" == "true" ]]; then
          awk '/^# \[susfs\]/{found=1; next} /^# \[/{found=0} found && NF' "$FRAGMENT" >> "$DEFCONFIG_FRAGMENT"
        fi

        if [[ "$ADD_OVERLAYFS" == "true" ]]; then
          awk '/^# \[overlayfs\]/{found=1; next} /^# \[/{found=0} found && NF' "$FRAGMENT" >> "$DEFCONFIG_FRAGMENT"
        fi

        if [[ "$ADD_KPM" == "true" && ("$KSU_VARIANT" == "SukiSU" || "$KSU_VARIANT" == "ReSukiSU") ]]; then
          awk '/^# \[kpm\]/{found=1; next} /^# \[/{found=0} found && NF' "$FRAGMENT" >> "$DEFCONFIG_FRAGMENT"
        fi

        if [[ "$ADD_ZRAM" == "true" ]]; then
          awk '/^# \[zram\]/{found=1; next} /^# \[/{found=0} found && NF' "$FRAGMENT" >> "$DEFCONFIG_FRAGMENT"
          sed -i 's/CONFIG_ZRAM=m/CONFIG_ZRAM=y/g' "$DEFCONFIG" 2>/dev/null || true
          sed -i 's/CONFIG_ZSMALLOC=m/CONFIG_ZSMALLOC=y/g' "$DEFCONFIG" 2>/dev/null || true
        fi

        # WildKernels standard fragment entries
        cat >> "$DEFCONFIG_FRAGMENT" << 'FRAGEOF'
        CONFIG_KSU=y
        CONFIG_KSU_SUSFS=y
        CONFIG_KALLSYMS=y
        CONFIG_KALLSYMS_ALL=y
        CONFIG_TMPFS_XATTR=y
        CONFIG_TMPFS_POSIX_ACL=y
        FRAGEOF
        sed -i 's/^        //' "$DEFCONFIG_FRAGMENT"

        # Dedup: last-wins for duplicate CONFIG_ keys
        tac "$DEFCONFIG_FRAGMENT" | awk -F= '/^CONFIG_/{if(seen[$1]++)next} {print}' | tac > "${DEFCONFIG_FRAGMENT}.tmp"
        mv "${DEFCONFIG_FRAGMENT}.tmp" "$DEFCONFIG_FRAGMENT"

        # ABI compare bypass (WildKernels exact logic)
        if [[ "$ANDROID_VER" == "android12" && "$KERNEL_VER" == "5.10" ]]; then
          sed -i 's/^\s*exit 1$/    echo "Bypassing ABI check"/' build/abi/compare_to_symbol_list
        elif [[ "$ANDROID_VER" == "android13" && "$KERNEL_VER" == "5.10" ]]; then
          sed -i 's/^\s*exit 1$/    echo "Bypassing ABI check"/' build/kernel/abi/compare_to_symbol_list
        elif [[ "$ANDROID_VER" == "android13" && "$KERNEL_VER" == "5.15" ]]; then
          sed -i 's/^\s*exit 1$/    echo "Bypassing ABI check"/' build/kernel/abi/compare_to_symbol_list
        elif [[ "$ANDROID_VER" == "android14" && "$KERNEL_VER" == "5.15" ]]; then
          perl -i -pe 's/^(\s*)return 1$/$1return 0/g if /if missing_symbols:/../return 1/' build/kernel/abi/check_buildtime_symbol_protection.py
        elif [[ "$ANDROID_VER" == "android14" && "$KERNEL_VER" == "6.1" ]]; then
          perl -i -pe 's/^(\s*)return 1$/$1return 0/g if /if missing_symbols:/../return 1/' build/kernel/abi/check_buildtime_symbol_protection.py
        elif [[ "$ANDROID_VER" == "android15" && "$KERNEL_VER" == "6.6" ]]; then
          perl -i -pe 's/^(\s*)return 1$/$1return 0/g if /if missing_symbols:/../return 1/' build/kernel/abi/check_buildtime_symbol_protection.py
        fi

        # Disable defconfig check
        if [[ "$KERNEL_VER" == "6.12" ]]; then
          sed -i '/name = "kernel_aarch64",/a\    check_defconfig = "disabled",' common/BUILD.bazel
        else
          sed -i 's/check_defconfig//' ./common/build.config.gki 2>/dev/null || true
        fi

    - name: Apply Module Check Bypass
      working-directory: ${{ env.KERNEL_ROOT }}
      env:
        KERNEL_VER: ${{ inputs.kernel_version }}
      run: |
        if [[ "$KERNEL_VER" == "6.1" || "$KERNEL_VER" == "6.6" || "$KERNEL_VER" == "6.12" ]]; then
          TARGET_FILE="$KERNEL_ROOT/common/kernel/module/version.c"
        else
          TARGET_FILE="$KERNEL_ROOT/common/kernel/module.c"
        fi

        sed -i '/bad_version:/{:a;n;/return 0;/{s/return 0;/return 1;/;b};ba}' "$TARGET_FILE"

    - name: Fix WiFi/BT on Samsung 6.6
      if: inputs.kernel_version == '6.6'
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        SYMBOL_LIST=android/abi_gki_aarch64_galaxy
        echo "kdp_set_cred_non_rcu" >> $SYMBOL_LIST
        echo "kdp_usecount_dec_and_test" >> $SYMBOL_LIST
        echo "kdp_usecount_inc" >> $SYMBOL_LIST

        PATCH="$KERNEL_PATCHES/samsung/min_kdp/add-min_kdp-symbols.patch"
        [ -f "$PATCH" ] && patch -p1 --dry-run < "$PATCH" 2>/dev/null && patch -p1 --no-backup-if-mismatch < "$PATCH" || true
        [ -f "$KERNEL_PATCHES/samsung/min_kdp/min_kdp.c" ] && cp "$KERNEL_PATCHES/samsung/min_kdp/min_kdp.c" drivers/min_kdp.c && echo "obj-y += min_kdp.o" >> drivers/Makefile || true

    - name: Fix WiFi/BT on Xiaomi 6.6
      if: inputs.kernel_version == '6.6'
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        [ -f android/abi_gki_aarch64_xiaomi ] && echo "device_find_any_child" >> android/abi_gki_aarch64_xiaomi

    - name: Clean Build Flags
      working-directory: ${{ env.KERNEL_ROOT }}
      env:
        KERNEL_VER: ${{ inputs.kernel_version }}
      run: |
        if [[ "$KERNEL_VER" == "5."* ]] || [[ "$KERNEL_VER" == "6.1" ]]; then
          perl -i -0777 -pe 's/(.*)echo "\$res"/$1echo "\$res-Wild"/s' ./common/scripts/setlocalversion
        else
          perl -i -0777 -pe 's/(.*)echo "\$\{KERNELVERSION\}\$\{file_localversion\}\$\{config_localversion\}\$\{LOCALVERSION\}\$\{scm_version\}"/$1echo "\${KERNELVERSION}\${file_localversion}\${config_localversion}\${LOCALVERSION}-Wild\${scm_version}"/s' ./common/scripts/setlocalversion
        fi

        if [ -f "build/build.sh" ]; then
          sed -i 's/-dirty//' ./common/scripts/setlocalversion
        else
          sed -i "/stable_scmversion_cmd/s/-maybe-dirty//g" ./build/kernel/kleaf/impl/stamp.bzl
          sed -i 's/-dirty//' ./common/scripts/setlocalversion
          rm -rf ./common/android/abi_gki_protected_exports_*
          perl -pi -e 's/^\s*"protected_exports_list"\s*:\s*"android\/abi_gki_protected_exports_aarch64",\s*$//;' ./common/BUILD.bazel
        fi

        cd common
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add .
        git commit -m "Wild: Clean Dirty Flag" || true

    - name: Set Stock Build Identity
      working-directory: ${{ env.KERNEL_ROOT }}/common
      env:
        INPUT_CODENAME: ${{ inputs.device_codename }}
        KERNEL_VER: ${{ inputs.kernel_version }}
      run: |
        PROFILE_FILE="$GITHUB_WORKSPACE/device-profiles.json"

        if [ ! -f "$PROFILE_FILE" ] || ! command -v jq &>/dev/null; then
          echo "IDENTITY_STATUS=Generic" >> "$GITHUB_ENV"
          exit 0
        fi

        if [ -n "$INPUT_CODENAME" ] && [ "$INPUT_CODENAME" != "generic" ]; then
          DEVICE_CODENAME="$INPUT_CODENAME"
        else
          DEVICE_CODENAME=$(jq -r --arg kv "$KERNEL_VER" --arg sl "$SUBLEVEL" \
            '[.devices | to_entries[] | select(.value.kernel_version == $kv and .value.sub_level == $sl) | .key] | first // empty' \
            "$PROFILE_FILE")
        fi

        if [ -z "$DEVICE_CODENAME" ]; then
          echo "IDENTITY_STATUS=Generic" >> "$GITHUB_ENV"
          exit 0
        fi

        DEVICE_EXISTS=$(jq -r ".devices.${DEVICE_CODENAME} // empty" "$PROFILE_FILE")
        if [ -z "$DEVICE_EXISTS" ]; then
          echo "IDENTITY_STATUS=Generic" >> "$GITHUB_ENV"
          exit 0
        fi

        STOCK_RELEASE=$(jq -r ".devices.${DEVICE_CODENAME}.stock_kernel.release" "$PROFILE_FILE")
        STOCK_VERSION=$(jq -r ".devices.${DEVICE_CODENAME}.stock_kernel.version_string" "$PROFILE_FILE")
        STOCK_BUILD_USER=$(jq -r ".devices.${DEVICE_CODENAME}.stock_kernel.build_user" "$PROFILE_FILE")
        STOCK_BUILD_HOST=$(jq -r ".devices.${DEVICE_CODENAME}.stock_kernel.build_host" "$PROFILE_FILE")
        STOCK_COMPILER=$(jq -r ".devices.${DEVICE_CODENAME}.stock_kernel.compiler_info // empty" "$PROFILE_FILE")

        if grep -q 'filechk_kernel.release.*KERNELVERSION' Makefile; then
          RELEASE_FMT="${STOCK_RELEASE}"
        else
          RELEASE_FMT="\${KERNELVERSION}${STOCK_RELEASE}"
        fi
        printf '#!/bin/sh\nprintf "%%s" "%s"\n' "$RELEASE_FMT" > scripts/setlocalversion
        chmod +x scripts/setlocalversion

        if [ -f "scripts/mkcompile_h" ]; then
          sed -i "s|UTS_VERSION=.*|UTS_VERSION=\"${STOCK_VERSION}\"|" scripts/mkcompile_h
          if grep -q "LINUX_COMPILE_BY=" scripts/mkcompile_h; then
            sed -i "s|LINUX_COMPILE_BY=.*|LINUX_COMPILE_BY=\"${STOCK_BUILD_USER}\"|" scripts/mkcompile_h
            sed -i "s|LINUX_COMPILE_HOST=.*|LINUX_COMPILE_HOST=\"${STOCK_BUILD_HOST}\"|" scripts/mkcompile_h
          fi
          if [ -n "$STOCK_COMPILER" ] && grep -q "LINUX_COMPILER=" scripts/mkcompile_h; then
            sed -i "s|LINUX_COMPILER=.*|LINUX_COMPILER=\"${STOCK_COMPILER}\"|" scripts/mkcompile_h
          fi
        fi

        {
          echo "KBUILD_BUILD_USER=$STOCK_BUILD_USER"
          echo "KBUILD_BUILD_HOST=$STOCK_BUILD_HOST"
          echo "IDENTITY_STATUS=Applied ($DEVICE_CODENAME)"
        } >> "$GITHUB_ENV"

    - name: Build Kernel
      working-directory: ${{ env.KERNEL_ROOT }}
      env:
        ANDROID_VER: ${{ inputs.android_version }}
        KERNEL_VER: ${{ inputs.kernel_version }}
        ADD_ZRAM: ${{ inputs.add_zram }}
      run: |
        if [[ "$ADD_ZRAM" == "true" ]]; then
          sed -i '/zsmalloc\.ko/d; /zram\.ko/d' common/android/gki_aarch64_modules 2>/dev/null || true
          sed -i '/zsmalloc\.ko/d; /zram\.ko/d' common/modules.bzl 2>/dev/null || true
          sed -i '/zsmalloc\.ko/d; /zram\.ko/d' common/BUILD.bazel 2>/dev/null || true
          sed -i 's/"kmi_symbol_list_strict_mode": True/"kmi_symbol_list_strict_mode": False/g' common/BUILD.bazel 2>/dev/null || true
        fi

        if [ -f "build/build.sh" ]; then
          KMI_SYMBOL_LIST_STRICT_MODE=0 HOSTLD=ld.lld GKI_DEFCONFIG_FRAGMENT="$DEFCONFIG_FRAGMENT" LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh || exit 1
        else
          if [[ "$ANDROID_VER" == "android14" ]]; then
            tools/bazel build --config=fast --lto=thin --defconfig_fragment=//common:arch/arm64/configs/wild_gki.fragment //common:kernel_aarch64_dist || exit 1
          else
            tools/bazel build --config=fast --lto=none --defconfig_fragment=//common:arch/arm64/configs/wild_gki.fragment //common:kernel_aarch64_dist || exit 1
          fi
        fi

    - name: Prepare AnyKernel3
      env:
        ANDROID_VER: ${{ inputs.android_version }}
        KERNEL_VER: ${{ inputs.kernel_version }}
      run: |
        if [ -f "$KERNEL_ROOT/out/${ANDROID_VER}-${KERNEL_VER}/dist/Image" ]; then
          cp "$KERNEL_ROOT/out/${ANDROID_VER}-${KERNEL_VER}/dist/Image" "$ANYKERNEL3/Image"
        elif [ -f "$KERNEL_ROOT/bazel-bin/common/kernel_aarch64/Image" ]; then
          cp "$KERNEL_ROOT/bazel-bin/common/kernel_aarch64/Image" "$ANYKERNEL3/Image"
        else
          echo "ERROR: No kernel Image found"
          find "$KERNEL_ROOT" -name "Image" -type f 2>/dev/null
          exit 1
        fi

    - name: Scan Patch Rejects
      if: always()
      run: |
        REJECTS_DIR="$GITHUB_WORKSPACE/patch-rejects"
        mkdir -p "$REJECTS_DIR"
        mapfile -t REJS < <(find "$KERNEL_ROOT" -type f -name '*.rej')
        REJ_COUNT=${#REJS[@]}
        echo "REJ_COUNT=$REJ_COUNT" >> "$GITHUB_ENV"
        if [ "$REJ_COUNT" -gt 0 ]; then
          for REJ in "${REJS[@]}"; do
            REL="${REJ#"$KERNEL_ROOT"/}"
            DEST="$REJECTS_DIR/$REL"
            mkdir -p "$(dirname "$DEST")"
            cp "$REJ" "$DEST"
            ORIG="${REJ%.rej}"
            [ -f "$ORIG" ] && cp "$ORIG" "$REJECTS_DIR/${REL%.rej}"
          done
        fi

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FILE_NAME }}-AnyKernel3
        path: ./AnyKernel3/**
        if-no-files-found: error
        compression-level: 9

    - name: Upload Rejects
      if: always() && env.REJ_COUNT > 0
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FILE_NAME }}-Rejects
        path: patch-rejects/
        if-no-files-found: ignore
        compression-level: 9
